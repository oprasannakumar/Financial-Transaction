<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Clean Statement Explorer</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: #f4f7f6; margin: 0; padding: 20px; }
        .container { max-width: 1400px; margin: auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); }
        .toolbar { display: flex; gap: 20px; align-items: flex-end; margin-bottom: 30px; border-bottom: 1px solid #edf2f7; padding-bottom: 20px; }
        .date-input { display: flex; flex-direction: column; gap: 6px; }
        label { font-size: 11px; font-weight: 700; color: #718096; letter-spacing: 0.5px; }
        input[type="date"] { padding: 10px; border: 1px solid #e2e8f0; border-radius: 6px; color: #2d3748; }
        
        button { padding: 10px 24px; border-radius: 6px; border: none; font-weight: 600; cursor: pointer; transition: 0.2s; }
        .btn-blue { background: #3182ce; color: white; }
        .btn-green { background: #38a169; color: white; display: none; }
        .btn-red { background: #e53e3e; color: white; display: none; }
        button:hover { opacity: 0.9; transform: translateY(-1px); }

        .sheet-card { margin-top: 30px; border: 1px solid #e2e8f0; border-radius: 8px; overflow: hidden; }
        .sheet-label { background: #2d3748; color: white; padding: 10px 15px; font-size: 14px; font-weight: 600; }
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th { background: #f7fafc; padding: 14px; text-align: left; border-bottom: 2px solid #edf2f7; color: #4a5568; white-space: nowrap; }
        td { padding: 12px 14px; border-bottom: 1px solid #edf2f7; color: #2d3748; white-space: nowrap; }
        tr:hover { background: #f8fafc; }

        #status { font-weight: 600; color: #3182ce; margin-bottom: 15px; min-height: 20px; }
    </style>
</head>
<body>

<div class="container">
    <div id="status">Ready.</div>
    <div class="toolbar">
        <div class="date-input">
            <label>START DATE</label>
            <input type="date" id="start">
        </div>
        <div class="date-input">
            <label>END DATE</label>
            <input type="date" id="end">
        </div>
        <button class="btn-blue" onclick="loadMain()">Search Statement</button>
        <button class="btn-green" id="fetchBtn" onclick="fetchAssociated()">Fetch Associated</button>
        <button class="btn-red" id="deleteBtn" onclick="deleteRecords()">Global Delete</button>
    </div>

    <div id="displayArea"></div>
</div>

<script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxeyI-iKfYu216UnB-6HBW1uuIwTzjykzOdLXaWK2JzxEl7XUF5ytr9hYWKmq4Batdtgg/exec';

    async function loadMain() {
        const s = document.getElementById('start').value;
        const e = document.getElementById('end').value;
        if(!s || !e) return alert("Select dates");

        const status = document.getElementById('status');
        status.innerText = "Processing records...";
        document.getElementById('displayArea').innerHTML = "";
        document.getElementById('deleteBtn').style.display = "none";
        document.getElementById('fetchBtn').style.display = "none";

        try {
            const res = await fetch(`${SCRIPT_URL}?action=getList&start=${s}&end=${e}`);
            const data = await res.json();
            
            if (!data.rows || data.rows.length === 0) {
                status.innerText = "No data found for this range.";
                return;
            }

            let html = `<div class='sheet-card'><div class='sheet-label'>Full Statement</div><div class='table-container'><table><thead><tr><th>Select</th>`;
            data.headers.forEach(h => html += `<th>${h}</th>`);
            html += `</tr></thead><tbody>`;
            
            data.rows.forEach(row => {
                const refId = row[row.length - 1];
                html += `<tr><td><input type="checkbox" class="sel" value="${refId}" onchange="toggleButtons()"></td>`;
                row.forEach(cell => html += `<td>${cell}</td>`);
                html += `</tr>`;
            });
            document.getElementById('displayArea').innerHTML = html + `</tbody></table></div></div>`;
            status.innerText = "Statement loaded successfully.";
        } catch(err) { status.innerText = "Connection error."; }
    }

    function toggleButtons() {
        const checked = document.querySelectorAll('.sel:checked').length > 0;
        document.getElementById('fetchBtn').style.display = checked ? "inline-block" : "none";
        document.getElementById('deleteBtn').style.display = checked ? "inline-block" : "none";
    }

    async function fetchAssociated() {
        const ids = Array.from(document.querySelectorAll('.sel:checked')).map(c => c.value.trim());
        document.getElementById('status').innerText = "Analyzing all workbook sheets...";
        try {
            const res = await fetch(`${SCRIPT_URL}?action=fetchAssociated&ids=${encodeURIComponent(ids.join(','))}`);
            const grouped = await res.json();
            let finalHtml = "";
            for (const name in grouped) {
                const sheet = grouped[name];
                finalHtml += `
                    <div class="sheet-card">
                        <div class="sheet-label">Sheet: ${name}</div>
                        <div class="table-container">
                            <table>
                                <thead><tr>${sheet.headers.map(h => `<th>${h}</th>`).join('')}</tr></thead>
                                <tbody>
                                    ${sheet.rows.map(r => `<tr>${r.map(c => `<td>${c}</td>`).join('')}</tr>`).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>`;
            }
            document.getElementById('displayArea').innerHTML = finalHtml || "No associated records discovered.";
            document.getElementById('status').innerText = "Search complete.";
        } catch(err) { document.getElementById('status').innerText = "Search failed."; }
    }

    async function deleteRecords() {
        const ids = Array.from(document.querySelectorAll('.sel:checked')).map(c => c.value.trim());
        if (!confirm(`Warning: This will permanently delete records across ALL sheets. Proceed?`)) return;

        document.getElementById('status').innerText = "Performing global deletion...";
        try {
            await fetch(SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                body: JSON.stringify({ action: 'deleteRows', ids: ids })
            });
            document.getElementById('status').innerText = "Data removed. Refreshing view...";
            setTimeout(loadMain, 2000);
        } catch(err) { document.getElementById('status').innerText = "Deletion failed."; }
    }
</script>
</body>
</html>
