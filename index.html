<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finance Command Center</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0f172a;
            --surface: #1e293b;
            --surface-accent: #334155;
            --primary: #38bdf8;
            --success: #4ade80;
            --danger: #fb7185;
            --gold: #fbbf24;
            --text: #f8fafc;
            --text-muted: #94a3b8;
            --border: rgba(255, 255, 255, 0.08);
            --shadow: 0 10px 15px -3px rgb(0 0 0 / 0.3);
        }
/* Header Filter Styles */
.header-filter-container {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 8px;
}

.filter-trigger {
    cursor: pointer;
    font-size: 10px;
    opacity: 0.5;
    transition: 0.2s;
}

.filter-trigger:hover { opacity: 1; color: var(--primary); }
.filter-active { opacity: 1; color: var(--primary); }

/* The actual dropdown menu */
.filter-dropdown {
    position: absolute;
    background: var(--surface);
    border: 1px solid var(--surface-accent);
    border-radius: 8px;
    box-shadow: var(--shadow);
    z-index: 100;
    min-width: 150px;
    max-height: 250px;
    overflow-y: auto;
    display: none;
    padding: 10px;
}

.filter-option {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 6px 8px;
    font-size: 12px;
    cursor: pointer;
    border-radius: 4px;
}

.filter-option:hover { background: rgba(255,255,255,0.05); }
.filter-option input { margin: 0; cursor: pointer; }

.filter-actions {
    display: flex;
    justify-content: space-between;
    margin-top: 10px;
    padding-top: 8px;
    border-top: 1px solid var(--border);
}
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; line-height: 1.6; }
        .container { max-width: 1400px; margin: auto; }

        /* Dashboard HUD */
        .dashboard { 
    display: grid; 
    grid-template-columns: repeat(3, 1fr); /* Forces 3 columns for the top cards */
    gap: 20px; 
    margin-bottom: 30px; 
}
        .stat-card {
            background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px);
            border-radius: 16px; padding: 20px; border: 1px solid var(--border); box-shadow: var(--shadow);
        }
        .stat-card.interactive { cursor: pointer; transition: 0.2s; }
        .stat-card.interactive:hover { border-color: var(--primary); transform: translateY(-3px); }

        .label { font-size: 10px; font-weight: 700; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.1em; }
        .value { font-size: 28px; font-weight: 800; }

        /* Toolbar Alignment */
        .toolbar { 
    display: flex; 
    flex-wrap: nowrap; /* Forces one single line */
    gap: 20px; 
    background: var(--surface); 
    padding: 12px 24px; /* Reduced padding for a sleeker bar */
    border-radius: 16px; 
    border: 1px solid var(--border);
    align-items: center; /* Vertically centers dates and buttons */
    box-shadow: var(--shadow); 
    margin-bottom: 30px;
    overflow-x: auto; /* Adds scroll if screen is too small */
}

        .controls-group { 
    display: flex; 
    align-items: center; 
    gap: 12px; 
    flex-shrink: 0;
}

        .date-input { 
    display: flex; 
    align-items: center; /* Aligns label and input side-by-side */
    gap: 8px; 
}
       .date-input label { 
    font-size: 10px; 
    font-weight: 700; 
    color: var(--text-muted); 
    white-space: nowrap; /* Prevents label from wrapping */
}
        .date-input label { 
    font-size: 10px; 
    font-weight: 700; 
    color: var(--text-muted); 
    white-space: nowrap; /* Prevents label from wrapping */
}
#cash-grid { 
    display: grid; 
    grid-template-columns: repeat(3, 1fr); /* Changed from 5 to 3 */
    gap: 6px; 
    margin-top: 10px; 
}
       .toolbar-metrics {
    display: flex; 
    gap: 24px; 
    padding-left: 24px; 
    margin-left: auto; 
    border-left: 1px solid var(--surface-accent);
    flex-shrink: 0;
}
/* Table Search Container */
.table-search-box {
    padding: 12px 20px;
    background: rgba(0,0,0,0.2);
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 12px;
}

.table-search-box input {
    background: var(--bg);
    border: 1px solid var(--surface-accent);
    color: #fff;
    padding: 8px 15px;
    border-radius: 8px;
    width: 100%;
    max-width: 400px;
    font-size: 13px;
    outline: none;
}

.table-search-box input:focus {
    border-color: var(--primary);
}

.row-hidden {
    display: none !important;
}

.match-highlight {
    background: rgba(56, 189, 248, 0.2);
    color: var(--primary);
    font-weight: bold;
}
        .metric-pill { display: flex; flex-direction: column; }
        .pill-label { font-size: 9px; font-weight: 800; color: var(--text-muted); text-transform: uppercase; }
        .pill-val { font-size: 16px; font-weight: 700; }

       button { 
    height: 34px; 
    padding: 0 16px; 
    border-radius: 10px; 
    border: none; 
    font-weight: 700; 
    font-size: 13px; 
    cursor: pointer; 
    transition: 0.2s; 
    display: flex; 
    align-items: center; 
    gap: 6px;
    white-space: nowrap;
}
        .btn-blue { background: var(--primary); color: var(--bg); }
        .btn-accent { background: #818cf8; color: white; }
        .btn-red { background: rgba(251, 113, 133, 0.2); color: var(--danger); border: 1px solid var(--danger); }
        button:hover { opacity: 0.9; transform: translateY(-1px); }

        .card-grid { 
    display: grid; 
    grid-template-columns: repeat(3, 1fr); /* Forces 3 columns for accounts */
    gap: 15px; 
    margin-top: 20px; 
}
        .fin-panel {
            background: var(--surface); border-radius: 12px; padding: 20px; border: 1px solid var(--border);
            border-right: 3px solid transparent; cursor: pointer; transition: 0.2s;
        }
        .fin-panel:hover { border-color: var(--primary); background: var(--surface-accent); }

        .sheet-card { background: var(--surface); border-radius: 16px; border: 1px solid var(--border); overflow: hidden; margin-top: 20px; }
        .table-wrap { max-height: 60vh; overflow-y: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th { text-align: left; padding: 12px 20px; color: var(--text-muted); background: rgba(0,0,0,0.3); position: sticky; top: 0; z-index: 10; }
        td { padding: 12px 20px; border-bottom: 1px solid var(--border); }
        tr:hover { background: rgba(255,255,255,0.02); }
        
        #status { font-size: 12px; color: var(--primary); margin-bottom: 10px; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <div id="status">Syncing Terminal...</div>

    <div class="dashboard">
        <div class="stat-card interactive" onclick="viewNamedRange('Savings')">
            <span class="label">Liquidity Pool</span>
            <div class="value" style="color: var(--success);" id="net-val">₹0.00</div>
        </div>
        <div class="stat-card interactive" onclick="viewNamedRange('CC')">
            <span class="label">Credit Exposure</span>
            <div class="value" style="color: var(--danger);" id="debt-val">₹0.00</div>
        </div>
        <div class="stat-card">
            <span class="label">Physical Cash <span style="float:right; color:var(--gold)" id="cash-total">₹0.00</span></span>
            <div id="cash-grid" style="display:grid; grid-template-columns: repeat(5,1fr); gap:5px; margin-top:10px;"></div>
        </div>
    </div>

<div class="toolbar">
    <div class="controls-group">
        <div class="date-input">
            <label>START</label>
            <input type="date" id="start">
        </div>
        <div class="date-input">
            <label>END</label>
            <input type="date" id="end">
        </div>

        <button class="btn-blue" onclick="loadMain()">Execute Search</button>
        <button class="btn-accent" id="fetchBtn" style="display:none" onclick="fetchAssociated()">Trace ID</button>
        <button class="btn-red" id="deleteBtn" style="display:none" onclick="deleteRecords()">Purge</button>
    </div>

    <div class="toolbar-metrics">
        <div class="metric-pill">
            <span class="pill-label">INFLOW</span>
            <span class="pill-val" id="bar-inflow" style="color: var(--success);">₹0.00</span>
        </div>
        <div class="metric-pill">
            <span class="pill-label">OUTFLOW</span>
            <span class="pill-val" id="bar-outflow" style="color: var(--danger);">₹0.00</span>
        </div>
    </div>
</div>
    <div id="displayArea"></div>
</div>

<script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxeyI-iKfYu216UnB-6HBW1uuIwTzjykzOdLXaWK2JzxEl7XUF5ytr9hYWKmq4Batdtgg/exec';

    function updateToolbarMetrics(headers, rows) {
        let inflow = 0, outflow = 0;
        const inIdx = headers.findIndex(h => /deposit amount/i.test(h));
        const outIdx = headers.findIndex(h => /withdrawn amount/i.test(h));

        rows.forEach(row => {
            if (inIdx !== -1) inflow += parseFloat(row[inIdx]?.toString().replace(/[^0-9.-]/g, "") || 0);
            if (outIdx !== -1) outflow += parseFloat(row[outIdx]?.toString().replace(/[^0-9.-]/g, "") || 0);
        });

        document.getElementById('bar-inflow').innerText = '₹' + inflow.toLocaleString('en-IN');
        document.getElementById('bar-outflow').innerText = '₹' + outflow.toLocaleString('en-IN');
    }

   window.onload = async () => {
    try {
        const res = await fetch(`${SCRIPT_URL}?action=getDashboard`);
        const data = await res.json();
        document.getElementById('net-val').innerText = '₹' + data.liquidity.toLocaleString('en-IN');
        document.getElementById('debt-val').innerText = '₹' + data.debt.toLocaleString('en-IN');
        document.getElementById('cash-total').innerText = '₹' + data.cashBreakdown[10].toLocaleString('en-IN');
        
        // Denominations list (Exactly 9 items for a 3x3 matrix)
        const denoms = [500, 200, 100, 50, 20, 10, 5, 2, 1];
        let html = "";
        
        denoms.forEach((v, i) => {
            // Added a slightly more modern pill-style look for the 3x3 grid
            html += `
                <div style="font-size:11px; text-align:center; background:rgba(255,255,255,0.05); border:1px solid var(--border); border-radius:8px; padding:6px 2px;">
                    <span style="color:var(--gold); display:block; font-size:9px; font-weight:800; margin-bottom:2px;">${v}</span>
                    <span style="font-weight:600;">${data.cashBreakdown[i+1]}</span>
                </div>`;
        });
        
        document.getElementById('cash-grid').innerHTML = html;
        document.getElementById('status').innerText = "Command Center Ready";
    } catch(e) { 
        document.getElementById('status').innerText = "Sync Failed"; 
    }
};
    async function loadMain() {
        const s = document.getElementById('start').value, e = document.getElementById('end').value;
        if(!s || !e) return alert("Select dates");
        document.getElementById('status').innerText = "Searching...";
        try {
            const res = await fetch(`${SCRIPT_URL}?action=getList&start=${s}&end=${e}`);
            const data = await res.json();
            if (!data.rows.length) {
                document.getElementById('status').innerText = "No records found.";
                return;
            }
            updateToolbarMetrics(data.headers, data.rows);
            renderTable(data.headers, data.rows);
            document.getElementById('status').innerText = "Results Displayed";
        } catch(e) { document.getElementById('status').innerText = "Query Failed"; }
    }

    // Shared table rendering logic
function renderTable(headers, rows) {
    let html = `
        <div class='sheet-card'>
            <div class="table-search-box">
                <input type="text" id="tableFilter" placeholder="Universal Search..." onkeyup="applyMultiFilter()">
                <span id="rowCount" style="font-size: 11px; color: var(--text-muted); margin-left: auto;">Showing ${rows.length} records</span>
            </div>
            <div class='table-wrap' style="position: relative;">
                <table id="mainDataTable">
                    <thead>
                        <tr>
                            <th>Sel</th>
                            ${headers.map((h, i) => `
                                <th>
                                    <div class="header-filter-container">
                                        <span>${h}</span>
                                        <span class="filter-trigger" onclick="toggleFilterDropdown(event, ${i+1})">▼</span>
                                    </div>
                                    <div id="filter-col-${i+1}" class="filter-dropdown">
                                        <div id="options-col-${i+1}"></div>
                                        <div class="filter-actions">
                                            <button class="btn-blue" style="font-size:9px; height:24px; padding:0 8px;" onclick="applyMultiFilter()">Apply</button>
                                            <button class="btn-red" style="font-size:9px; height:24px; padding:0 8px;" onclick="clearFilter(${i+1})">Clear</button>
                                        </div>
                                    </div>
                                </th>`).join('')}
                        </tr>
                    </thead>
                    <tbody>
                        ${rows.map(row => {
                            const id = row[row.length - 1];
                            return `<tr class="data-row">
                                <td><input type="checkbox" class="sel" value="${id}" onchange="toggleButtons()"></td>
                                ${row.map(c => `<td>${c}</td>`).join('')}
                            </tr>`;
                        }).join('')}
                    </tbody>
                </table>
            </div>
        </div>`;
    document.getElementById('displayArea').innerHTML = html;
    populateFilterOptions(headers, rows);
}

let activeFilters = {};

function toggleFilterDropdown(event, colIdx) {
    event.stopPropagation();
    const dropdown = document.getElementById(`filter-col-${colIdx}`);
    const isVisible = dropdown.style.display === 'block';
    
    // Close all other dropdowns
    document.querySelectorAll('.filter-dropdown').forEach(d => d.style.display = 'none');
    dropdown.style.display = isVisible ? 'none' : 'block';
}

function populateFilterOptions(headers, rows) {
    headers.forEach((h, i) => {
        const colIdx = i + 1;
        const uniqueValues = [...new Set(rows.map(r => r[i]))].sort();
        const container = document.getElementById(`options-col-${colIdx}`);
        
        container.innerHTML = uniqueValues.map(val => `
            <div class="filter-option">
                <input type="checkbox" class="col-filter-check" data-col="${colIdx}" value="${val}" onchange="applyMultiFilter()">
                <span>${val}</span>
            </div>
        `).join('');
    });
}

function applyMultiFilter() {
    const universalSearch = document.getElementById('tableFilter').value.toLowerCase();
    const table = document.getElementById('mainDataTable');
    const rows = table.getElementsByClassName('data-row');
    
    // Get all checked values for each column
    const columnFilters = {};
    document.querySelectorAll('.col-filter-check:checked').forEach(check => {
        const col = check.getAttribute('data-col');
        if (!columnFilters[col]) columnFilters[col] = [];
        columnFilters[col].push(check.value.toLowerCase());
    });

    let visibleCount = 0;

    for (let i = 0; i < rows.length; i++) {
        const cells = rows[i].getElementsByTagName('td');
        let matchesUniversal = universalSearch === "";
        let matchesColumnFilters = true;

        // Check Universal Search
        for (let j = 1; j < cells.length; j++) {
            if (cells[j].textContent.toLowerCase().includes(universalSearch)) {
                matchesUniversal = true;
                break;
            }
        }

        // Check Column-specific Dropdowns
        for (const colIdx in columnFilters) {
            const cellText = cells[colIdx].textContent.toLowerCase();
            if (!columnFilters[colIdx].includes(cellText)) {
                matchesColumnFilters = false;
                break;
            }
        }

        if (matchesUniversal && matchesColumnFilters) {
            rows[i].classList.remove('row-hidden');
            visibleCount++;
        } else {
            rows[i].classList.add('row-hidden');
        }
    }

    document.getElementById('rowCount').innerText = `Showing ${visibleCount} records`;
    recalculateMetricsFromVisible();
}

function clearFilter(colIdx) {
    document.querySelectorAll(`.col-filter-check[data-col="${colIdx}"]`).forEach(c => c.checked = false);
    applyMultiFilter();
}

// Close dropdowns when clicking outside
document.addEventListener('click', () => {
    document.querySelectorAll('.filter-dropdown').forEach(d => d.style.display = 'none');
});

function applyTableFilter() {
    const input = document.getElementById('tableFilter');
    const filter = input.value.toLowerCase();
    const table = document.getElementById('mainDataTable');
    const rows = table.getElementsByClassName('data-row');
    let visibleCount = 0;

    for (let i = 0; i < rows.length; i++) {
        const cells = rows[i].getElementsByTagName('td');
        let found = false;
        
        // Start loop from index 1 to skip the checkbox column
        for (let j = 1; j < cells.length; j++) {
            const content = cells[j].textContent || cells[j].innerText;
            if (content.toLowerCase().indexOf(filter) > -1) {
                found = true;
                break;
            }
        }

        if (found) {
            rows[i].classList.remove('row-hidden');
            visibleCount++;
        } else {
            rows[i].classList.add('row-hidden');
        }
    }
    
    // Update the row count display
    document.getElementById('rowCount').innerText = `Showing ${visibleCount} records`;
    
    // Recalculate Toolbar Metrics based on VISIBLE rows only
    recalculateMetricsFromVisible();
}

// Optional: Dynamic metrics update while filtering
function recalculateMetricsFromVisible() {
    const table = document.getElementById('mainDataTable');
    if (!table) return;

    const rows = Array.from(table.getElementsByClassName('data-row'))
                      .filter(r => !r.classList.contains('row-hidden'));
    
    // We need the headers to find correct indices
    const headers = Array.from(table.querySelectorAll('th')).map(th => th.innerText);
    const inIdx = headers.findIndex(h => /deposit amount/i.test(h));
    const outIdx = headers.findIndex(h => /withdrawn amount/i.test(h));

    let inflow = 0, outflow = 0;

    rows.forEach(row => {
        const cells = row.getElementsByTagName('td');
        if (inIdx !== -1) {
            let val = cells[inIdx].innerText.replace(/[^0-9.-]/g, "");
            inflow += parseFloat(val) || 0;
        }
        if (outIdx !== -1) {
            let val = cells[outIdx].innerText.replace(/[^0-9.-]/g, "");
            outflow += parseFloat(val) || 0;
        }
    });

    document.getElementById('bar-inflow').innerText = '₹' + inflow.toLocaleString('en-IN');
    document.getElementById('bar-outflow').innerText = '₹' + outflow.toLocaleString('en-IN');
}
    async function viewNamedRange(rangeName) {
        document.getElementById('status').innerText = `Fetching ${rangeName}...`;
        try {
            const res = await fetch(`${SCRIPT_URL}?action=fetchNamedRange&range=${rangeName}`);
            const data = await res.json();
            let html = `<div class="card-grid">`;
            data.rows.forEach(row => {
                const color = rangeName === 'Savings' ? 'var(--success)' : 'var(--danger)';
                html += `
                    <div class="fin-panel" style="border-right-color:${color}" onclick="filterLedgerByEntity('${rangeName}', '${row[0]}')">
                        <div class="label">${rangeName === 'Savings' ? 'ASSET' : 'DEBT'}</div>
                        <div style="font-size:14px; font-weight:700;">${row[0]}</div>
                        <div style="font-size:22px; font-weight:800; color:${color}; margin:10px 0;">₹${(Number(row[2]) || 0).toLocaleString('en-IN')}</div>
                        <div style="font-size:10px; color:var(--text-muted)">${rangeName === 'CC' ? 'Limit: ₹' + (Number(row[1])||0).toLocaleString('en-IN') : 'Opening: ₹' + (Number(row[1])||0).toLocaleString('en-IN')}</div>
                        ${rangeName === 'CC' ? `<div style="font-size:10px; color:var(--success)">Available: ₹${(Number(row[3])||0).toLocaleString('en-IN')}</div>` : ''}
                    </div>`;
            });
            document.getElementById('displayArea').innerHTML = html + `</div>`;
            document.getElementById('status').innerText = "Selection Ready";
        } catch(e) { }
    }

    async function filterLedgerByEntity(type, query) {
        document.getElementById('status').innerText = `Filtering for ${query}...`;
        try {
            const res = await fetch(`${SCRIPT_URL}?action=searchStatementByEntity&type=${type}&query=${encodeURIComponent(query)}`);
            const data = await res.json();
            updateToolbarMetrics(data.headers, data.rows);
            let backBtn = `<div style="margin-bottom:20px; display:flex; justify-content:space-between; align-items:center;">
                <button class="btn-blue" onclick="viewNamedRange('${type}')" style="background:var(--surface-accent); color:white;">← Back</button>
                <span class="label" style="font-size:14px;">Log: ${query}</span>
            </div>`;
            renderTable(data.headers, data.rows);
            document.getElementById('displayArea').insertAdjacentHTML('afterbegin', backBtn);
            document.getElementById('status').innerText = "Filter Applied";
        } catch(e) { }
    }

    // --- ADDED MISSING LOGIC BELOW ---

    async function fetchAssociated() {
        const ids = Array.from(document.querySelectorAll('.sel:checked')).map(c => c.value.trim());
        document.getElementById('status').innerText = "Tracing cross-sheet references...";
        try {
            const res = await fetch(`${SCRIPT_URL}?action=fetchAssociated&ids=${encodeURIComponent(ids.join(','))}`);
            const grouped = await res.json();
            let finalHtml = "";
            for (const name in grouped) {
                const sheet = grouped[name];
                finalHtml += `<div class="sheet-card"><div class="sheet-label" style="padding:10px 20px; background:rgba(255,255,255,0.05); color:var(--primary); font-weight:bold; border-bottom:1px solid var(--border)">Origin: ${name}</div><div class="table-wrap"><table><thead><tr>${sheet.headers.map(h => `<th>${h}</th>`).join('')}</tr></thead><tbody>${sheet.rows.map(r => `<tr>${r.map(c => `<td>${c}</td>`).join('')}</tr>`).join('')}</tbody></table></div></div>`;
            }
            document.getElementById('displayArea').innerHTML = finalHtml || "<div class='stat-card'>No secondary references found.</div>";
            document.getElementById('status').innerText = "Trace Complete";
        } catch(e) { document.getElementById('status').innerText = "Trace Failed"; }
    }

async function deleteRecords() {
        const ids = Array.from(document.querySelectorAll('.sel:checked')).map(c => c.value.trim());
        if (!confirm(`GLOBAL PURGE: Delete ${ids.length} records from ALL sheets?`)) return;

        const status = document.getElementById('status');
        status.innerText = "Executing Purge...";

        try {
            // Send the delete request
            await fetch(SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                body: JSON.stringify({ action: 'deleteRows', ids: ids })
            });

            status.innerText = "Purge successful. Updating systems...";
            
            // Wait 1.5 seconds for Google Sheets to process the deletion, then reload everything
            setTimeout(async () => {
                // 1. Refresh the top dashboard HUD (Liquidity, Debt, Cash)
                await window.onload(); 
                
                // 2. Clear the ledger area or reload the current search
                const s = document.getElementById('start').value;
                const e = document.getElementById('end').value;
                if (s && e) {
                    await loadMain(); // Reload the specific date range
                } else {
                    document.getElementById('displayArea').innerHTML = ""; // Just clear if no dates set
                }
                
                status.innerText = "Terminal Synced & Reloaded.";
            }, 1500);

        } catch(e) { 
            status.innerText = "Purge failed. Check connection."; 
            console.error(e);
        }
    }
    function toggleButtons() {
        const count = document.querySelectorAll('.sel:checked').length;
        document.getElementById('fetchBtn').style.display = count ? "flex" : "none";
        document.getElementById('deleteBtn').style.display = count ? "flex" : "none";
    }
</script>
</body>
</html>
